var AnimationFramer=this.AnimationFramer=function(){var t,e=this;return e.init=function(){t=[],requestAnimationFrame(n)},e.requestAnimationFrameCallback=function(e){t.push(e)},e;function n(){for(var e=0;e<t.length;e++)t[e]();requestAnimationFrame(n)}},AudioSupervisor=this.AudioSupervisor=function(){var n,e=this;return e.init=function(e){document.addEventListener&&document.addEventListener("visibilitychange",t),Tone.Transport.latencyHint=isMobile()&&!isIPhone()?.06:"fastest",n=[]},e.makeGestureOnElementResumeAudioContext=function(e){function t(){Tone.context.resume().then(function(){e.removeEventListener("touchstart",t,!0),e.removeEventListener("touchend",t,!0),e.removeEventListener("mousedown",t,!0),e.removeEventListener("mouseup",t,!0),e.removeEventListener("click",t,!0)})}e.addEventListener("touchstart",t,!0),e.addEventListener("touchend",t,!0),e.addEventListener("mousedown",t,!0),e.addEventListener("mouseup",t,!0),e.addEventListener("click",t,!0)},e.registerPlayingWidget=function(e){-1==n.indexOf(e)&&n.push(e)},e.unregisterPlayingWidget=function(t){n=n.filter(function(e){return e!=t})},e.isOnlyWidgetPlaying=function(e){return 1===n.length&&n[0]===e},e.areAnyWidgetsPlaying=function(){return 0<n.length},e.masterEffectChain=function(){return Tone.Destination},e;function t(){document.hidden&&Tone?Tone.Destination.volume.rampTo(-1/0,.3):Tone&&Tone.Destination.volume.rampTo(0,.4)}},BrowserCompatibility={isBrowserCompatible:function(){var e=window.hasOwnProperty("AudioContext")||window.hasOwnProperty("webkitAudioContext"),t=window.hasOwnProperty("Promise"),n=window.hasOwnProperty("Worker");return e&&t&&n},appendCompatibilityWarning:function(e,t){var n=document.createElement("div");n.className="widget__compatibility-message",n.innerHTML=t,e.appendChild(n)}},Drumkit=this.Drumkit=function(){var e,o,t=this;return t.init=function(n){if(e)return e;return e=new Promise(function(e){var t={};n.forEach(function(e){t[e.midi+""]=pathToWidgetSounds()+e.path+getAudioExtension()}),(o=new Tone.Players({urls:t,onload:function(){e()}}).toDestination()).fadeOut=.01})},t.playNoteAtNumber=n,t.playNotes=function(e){e.forEach(function(t){e.some(function(e){return t.lane.midi===e.lane.choke})||n(t.lane.midi,t.time,t.lane.choke)})},t.stopAll=function(){o.stopAll()},t;function n(e,t,n){o.player(e+"").start(t),n&&o.player(n+"").stop(t)}},KeySupervisor=this.KeySupervisor=function(){var t,o,i,r,e=this;return e.init=function(e){document.addEventListener("keydown",function(e){!function(e){return!0===t[e.keyCode]}(e)&&(t[e.keyCode]=!0,o&&o(e))},!0),document.addEventListener("keyup",function(e){t[e.keyCode]=!1,i&&i(e)},!0),document.addEventListener&&document.addEventListener("visibilitychange",n),t={}},e.connectWidget=function(e,t,n){r&&r();o=e,i=t,r=n},e;function n(){document.hidden&&r&&(r(),r=i=o=null)}},LiveSetExport={serviceURL:"https://learningmusic-export.ableton.com",checkExportServiceAvailablility:function(e){var t=new XMLHttpRequest;t.timeout=5e3,t.addEventListener("load",function(){e(!0)}),t.addEventListener("error",function(){e(!1)}),t.addEventListener("abort",function(){e(!1)}),t.addEventListener("timeout",function(){e(!1)}),t.open("GET",LiveSetExport.serviceURL+"/availability"),t.send()},createLiveSet:function(e,t,n){var o=(new Date).toDateString().replace(/[^a-z0-9]/gi,"_"),i={backlink:window.location.href,name:"idea_"+o,tempo:e,tracks:t};if(!LiveSetExport.userHasAlreadyExportedOnce())var r=window.open(LOCALE_PATH+"/live-set-export-waiting.html","_blank");var a=new XMLHttpRequest;a.addEventListener("load",function(){n(void 0);var e=this.responseText;if(LiveSetExport.userHasAlreadyExportedOnce())LiveSetExport.isValidFileId(e)&&(window.location=LiveSetExport.downloadURLFromFileId(e));else{storageAvailable()&&localStorage.setItem("__userHasExported","yes");var t="?fileId="+e;r.location.href=LOCALE_PATH+"/live-set-export.html"+t}}),a.addEventListener("error",function(){n("Export failed.")}),a.addEventListener("abort",function(){n("Export was cancelled.")}),a.open("POST",LiveSetExport.serviceURL+"/export"),a.setRequestHeader("Content-Type","application/json;charset=UTF-8"),a.send(JSON.stringify(i))},downloadURLFromFileId:function(e){return LiveSetExport.serviceURL+"/export?id="+e},userHasAlreadyExportedOnce:function(){return!!storageAvailable()&&"yes"==localStorage.getItem("__userHasExported")},isValidFileId:function(e){return e.match("[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}")},createDownloadLink:function(e,t){var n,o,i,r=(n="fileId",o=window.location.href,(i=new RegExp("[?&]"+n+"=([^&#]*)","i").exec(o))?i[1]:null);if(LiveSetExport.isValidFileId(r)){void 0===t&&(t="");var a=document.createElement("a"),s=document.createTextNode("Download");a.appendChild(s),a.title="Download your music as an Ableton Live Set",a.href=LiveSetExport.downloadURLFromFileId(r),a.className=t,document.getElementById(e).appendChild(a),a.addEventListener("click",function(){a.style.display="none"})}else document.getElementById(e).innerHTML="Error exporting to Live. Please try again."}},LiveSetExporter=this.LiveSetExporter=function(){var i;return this.init=function(){i=[]},this.registerWidget=function(e){i.push(e),e.bind("export",function(e,t){var n=e.getExportInfo();if("takeover"===e.getConfig().onPlay)LiveSetExport.createLiveSet(n.tempo,n.tracks,t);else{var o=i.reduce(function(e,t){return e.concat(t.getExportInfo().tracks)},[]);LiveSetExport.createLiveSet(n.tempo,o,t)}})},this},Loader=this.Loader=function(){var t,n;return this.init=function(e){(t=document.createElement("div")).id=e.widgetId+"loader",t.className="",(n=document.createElement("div")).className="widget-loader__loading-animation",t.appendChild(n),document.getElementById(e.widgetId).appendChild(t)},this.hide=function(){t.style.display="none"},this.onAudioLoaded=function(){n.style.display="none"},this},Metronome=this.Metronome=function(){var o,t;return this.init=function(e){var t=pathToWidgetSounds(),n={metro:t+"metronome/Metronome"+getAudioExtension(),metroup:t+"metronome/MetronomeUp"+getAudioExtension()};(o=new Tone.Players({urls:n,onload:function(){i()}}).toDestination()).volume.value=12},this.start=function(e){i(),t.start(e)},this.stop=function(e){t.stop(e),t.dispose()},this;function i(){t=new Tone.Sequence(function(e,t){o.player(t).start(e)},["metroup","metro","metro","metro"],"4n")}},Piano=this.Piano=function(){var e,o,t=this;return t.init=function(n){n,e=e||new Promise(function(e){var t={};n.samples.forEach(function(e){t[e.midi+""]=pathToWidgetSounds()+e.path+getAudioExtension()}),(o=new Tone.Sampler({urls:t,onload:function(){e()}}).toDestination()).release=n.fadeout.duration});return e},t.playNoteAtFrequency=function(e,t,n){i(Math.round(Tone.Frequency(e).toMidi()),t,n)},t.playNoteAtNumber=i,t.stopAll=function(){o.releaseAll()},t;function i(e,t,n){o.triggerAttackRelease(Tone.Frequency(e,"midi").toNote(),n,t)}},Recorder=this.Recorder=function(){var t;return this.init=function(e){},this.recordEvent=function(e){t&&t(e)},this.connect=function(e){t=e},this},SingleTouchObserver=this.SingleTouchObserver=function(){var r,a;return this.init=function(e){r=e;var t=document.createElement("div");t.classList.add("mouseObserver"),t.style.width="100%",t.style.height="100%",t.addEventListener("mousedown",n),t.addEventListener("touchstart",n),e.node.appendChild(t)},this;function n(e){if("mousedown"!==e.type||0===e.button){e.cancelable&&e.preventDefault(),e.changedTouches&&(e=event.changedTouches[0]),document.addEventListener("mousemove",o),document.addEventListener("touchmove",o),document.addEventListener("mouseup",i),document.addEventListener("touchend",i),a=r.node.getBoundingClientRect();var t=e.clientX-a.left,n=e.clientY-a.top;r.onDown(t,n),document.activeElement&&document.activeElement.blur()}function o(e){e.changedTouches&&(e=event.changedTouches[0]);var t=e.clientX-a.left,n=e.clientY-a.top;r.onMove(t,n)}function i(e){document.removeEventListener("mousemove",o),document.removeEventListener("touchmove",o),document.removeEventListener("mouseup",i),document.removeEventListener("touchend",i),e.changedTouches&&(e=event.changedTouches[0]);var t=e.clientX-a.left,n=e.clientY-a.top;r.onUp(t,n)}}},Tooltip={inject:function(e,t,n,o,i){if(t&&e&&!(Tooltip.userHasSeenTooltip(t.name)&&!t.showalways)){e.getBoundingClientRect();xShiftFactor=0,"left"==i?xShiftFactor=.25:"right"==i&&(xShiftFactor=-.25),xShiftInPx=200*xShiftFactor;var r=document.createElement("div");r.dir="auto",r.className="widget-tooltip",r.style.width="200px",r.style.top=n||"100%",r.style.left=o||"50%",r.style.marginTop="12px",r.style.marginLeft=-100+xShiftInPx+"px";var a=document.createElement("div");a.className="widget-tooltip__triangle",a.style.top="-20px",a.style.left=90-xShiftInPx+"px",a.style.border="solid 10px",a.style.borderColor="transparent transparent black transparent",r.appendChild(a);var s=document.createElement("div");s.className="widget-tooltip__text",s.innerHTML=t["@text"],r.appendChild(s);var l=document.createElement("div");l.className="widget-tooltip__dismiss",l.innerHTML=t["@close"]?t["@close"]:"Close",r.appendChild(l),r.addEventListener("click",function(){r.classList.add("widget-tooltip--hide"),Tooltip.setUserHasSeenTooltip(t.name)}),e.appendChild(r)}},tooltipKeyForLocalStorage:function(e){return"__tooltip_"+e},userHasSeenTooltip:function(e){return!!storageAvailable()&&"dismissed"==localStorage.getItem(Tooltip.tooltipKeyForLocalStorage(e))},setUserHasSeenTooltip:function(e){storageAvailable()&&localStorage.setItem(Tooltip.tooltipKeyForLocalStorage(e),"dismissed")},appendTooltippableChild:function(e,t){var n=document.createElement("div");n.style.position="relative",n.appendChild(t),e.appendChild(n)}},Transport=this.Transport=function(){var t,n,o,i,r,a,s,e=this;return e.init=function(e){n=e,(t=document.createElement("div")).className="widget-transport",e.node.appendChild(t),(o=document.createElement("button")).onclick=f,Tooltip.appendTooltippableChild(t,o),o.parentElement.classList.add("widget__transport-btn-wrapper"),(i=document.createElement("button")).onclick=g,Tooltip.appendTooltippableChild(t,i),i.parentElement.classList.add("widget__transport-btn-wrapper"),r="stopped",a=!1,s=e.tempo,Tone.Transport.on("takeover",c),Tone.Transport.on("sessionTempoChanged",l),d()},e.isRecording=function(){return a},e.isPlaying=function(){return"playing"==r},e.getTempo=function(){return s},e.setTempo=function(e){s=e,("join"==n.onPlay||"takeover"==n.onPlay&&"playing"==r)&&(Tone.Transport.bpm.value=s,Tone.Transport.emit("sessionTempoChanged",s));n.onTempoChanged&&n.onTempoChanged(s)},e.playButton=function(){return o},e.recordButton=function(){return i},e;function l(e){"join"==n.onPlay&&(s=e,n.onTempoChanged&&n.onTempoChanged(s))}function d(){o.innerHTML={playing:"<i class='icon-pause'></i>",queued:"<i class='icon-play widget_transport-icon--queued'></i>",stopped:"<i class='icon-play'></i>"}[r],o.className="btn widget__transport-btn",function(){i.innerHTML="<i class='icon-record'></i>";var e=n.showRecordButton?"":" hidden";i.className=a&&"playing"==r?"btn widget__transport-btn widget-button--recording"+e:"btn widget__transport-btn"+e}()}function u(){a&&(a=!1,METRONOME.stop()),n.onStopPlayback(),SUPERVISOR.unregisterPlayingWidget(n.widgetId),r="stopped",d()}function c(e){"playing"==r&&u()}function p(){Tone.Transport.bpm.value=s,Tone.Transport.position="0:0:0",Tone.Transport.start(ToneTransportStartDelay()),a&&METRONOME.start(),n.onStartPlayback(),SUPERVISOR.registerPlayingWidget(n.widgetId),r="playing",d()}function m(){Tone.Transport.position="0:0:0",Tone.Transport.stop(),u()}function f(){if(!0,"queued"!=r)if(SUPERVISOR.areAnyWidgetsPlaying()){if(SUPERVISOR.areAnyWidgetsPlaying()){var e="playing"==r;"takeover"==n.onPlay?e?m():(Tone.Transport.emit("takeover"),m(),p()):"join"==n.onPlay&&(e?SUPERVISOR.isOnlyWidgetPlaying(n.widgetId)?m():c():(a&&METRONOME.start(Workarounds.transportTimeForNextMeasure()),Tone.Transport.scheduleOnce(function(e){r="playing",d()},Workarounds.transportTimeForNextMeasure()),n.onStartQuantizedPlayback(),SUPERVISOR.registerPlayingWidget(n.widgetId),r="queued",d()))}}else p()}function g(){a=!a,"playing"==r?a?METRONOME.start("0:0:0"):METRONOME.stop():f(),d()}};function canPlayAudio(e){return Tone.Buffer.supportsType(e)}function getAudioExtension(){var e=".wav";return canPlayAudio("ogg")?e=".ogg":canPlayAudio("mp4")&&(e=".mp4"),e}function pathToWidgetSounds(){return"/lessons/sounds/"}function pctInRange(e,t,n){return(n-e)/(t-e)}function clamp(e,t,n){return Math.min(Math.max(e,t),n)}function fitsInRange(e,t,n){return e<=n&&n<=t}function almostEqual(e,t,n){return null==n&&(n=.001),Math.abs(e-t)<n}function nearest(e,t){for(var n=Number.MAX_VALUE,o=0;o<t.length;o++){var i=t[o],r=Math.abs(e-n);Math.abs(e-i)<=r&&(n=i)}return n}function debounce(n,o){var i;return function(){var e=this,t=arguments;clearTimeout(i),i=setTimeout(function(){i=null,n.apply(e,t)},o)}}function assert(e,t){if(!e){if(t=t||"Assertion failed","undefined"!=typeof Error)throw new Error(t);throw t}}function storageAvailable(){return void 0!==window.localStorage}function getSavedModelString(e){return storageAvailable()?localStorage.getItem(e):void 0}function getSavedModel(e){try{return JSON.parse(getSavedModelString(e))}catch(e){return}}function tryRestoreApp(e,t,n){var o=getSavedModel(e);if(o&&o.version==n)return t.ports.importModel.send(o),o}function trySaveState(e,t,n){if(storageAvailable())try{var o=e;o.version=n;var i=JSON.stringify(o);localStorage.setItem(t,i),isDeveloperMode()&&console.log(i)}catch(e){return}}var DEVELOPER_MODE=!1;function isDeveloperMode(){return window.location.href.includes("localhost")||DEVELOPER_MODE}var IS_MOBILE=navigator.userAgent.match(/Android/i)||navigator.userAgent.match(/webOS/i)||navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPad/i)||navigator.userAgent.match(/iPod/i)||navigator.userAgent.match(/BlackBerry/i)||navigator.userAgent.match(/Windows Phone/i);function isMobile(){return IS_MOBILE}function isChromeOnIOS(){return!!navigator.userAgent.match("CriOS")}function isIPhone(){return!!navigator.userAgent.match("iPhone")}function keyFromPhysicalCode(e){return e.includes("Digit")?e.split("Digit")[1]:e.includes("Key")?e.split("Key")[1]:void 0}function keyEventToPhysicalKey(e){return e.code?keyFromPhysicalCode(e.code):String.fromCharCode(e.keyCode)}function clearCookies(){function n(e,t){document.cookie=t?e+"=; Path=/; Domain="+t+"; Expires=Thu, 01 Jan 1970 00:00:01 GMT;":e+"=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;"}try{document.cookie.split(";").forEach(function(e){var t=e.split("=")[0];t&&0===t.indexOf("_g")?n(t,document.domain):t&&n(t)})}catch(e){console.log()}}function ToneTransportStartDelay(){return"+0.1"}clearCookies();var GLOBAL_PITCHPAD_SYNTH,Workarounds={transportTimeForNextMeasure:function(){var e=Tone.Transport.position;return"0:0:0"===e?e:parseInt(e.split(":")[0])+1+":0:0"}},PitchpadSynth=this.PitchpadSynth=function(){var r,a,s,l,d,u,e=this;return e.init=function(e){r=[],a=3,s=[],l=[],d=[],mFilter=[],u=Tone.context.createGain(),Tone.connect(u,Tone.Destination),u.gain.value=.5;for(var t=0;t<a;t++){r[t]=null;var n=Tone.context.createOscillator(),o=Tone.context.createGain(),i=Tone.context.createBiquadFilter();i.type="lowpass",i.frequency.value=1e3,n.type="sawtooth",n.connect(i),i.connect(o),o.connect(u),o.gain.value=1e-6,n.start(0),s.push(n),l.push(o),d.push(-1),mFilter.push(i)}},e.startTouch=function(e,t){var n=r.findIndex(function(e){return null===e});if(-1==n)return;r[n]=e,s[n].frequency.setValueAtTime(t,Tone.context.currentTime),d[n]=t,c(n)},e.moveTouch=function(e,t,n){var o=i(e);if(-1==o)return;s[o].frequency.setValueAtTime(t,Tone.context.currentTime),n&&!almostEqual(t,d[o])&&c(o);d[o]=t},e.stopTouch=t,e.stopAll=function(){for(var e=0;e<a;e++)t(r[e])},e;function i(t){return r.findIndex(function(e){return e===t})}function c(e){var t=Tone.context.currentTime;l[e].gain.cancelScheduledValues(t),l[e].gain.setTargetAtTime(.75,t+.02,.001),l[e].gain.setTargetAtTime(.3,t+.02+.1,.01),mFilter[e].frequency.setTargetAtTime(2500,t+.02,.001),mFilter[e].frequency.setTargetAtTime(2e3,t+.02+.1,.1)}function t(e){var t=i(e);-1!=t&&(function(e){var t=Tone.context.currentTime;l[e].gain.cancelScheduledValues(t),l[e].gain.setTargetAtTime(0,t+.05,.15),mFilter[e].frequency.setTargetAtTime(100,t+.05,.5)}(t),r[t]=null,d[t]=-1)}},ScaleExplorer=this.ScaleExplorer=function(){var i,a,r,s,l,d,u,c,p,m,f;return this.init=function(e){if(!BrowserCompatibility.isBrowserCompatible())return void BrowserCompatibility.appendCompatibilityWarning(document.getElementById(e.widgetId),e.lang["@incompatiblebrowser"]);i=e,mLoader=new Loader,mLoader.init(e),mLoader.onAudioLoaded(),function(){SUPERVISOR.makeGestureOnElementResumeAudioContext(document.getElementById(i.widgetId)),(t=document.getElementById(i.widgetId)).style.position="relative";var e=document.createElement("div");e.id=i.widgetId+"appHolder",e.style.textAlign="center",t.appendChild(e),(f=Elm.ScaleExplorer.ScaleExplorer.init({node:e,flags:{scale:R(),startNote:function(){var e=R()[0];return e-e%12}(),customNoteNames:x()?null:i.frequencies.map(function(e){return e.name}),customNoteColors:x()?null:i.frequencies.map(function(e){return e.color?e.color:""}),showPiano:"yes"==i.showPiano,showPads:i.isQuantized,showScaleChooser:"yes"==i.showScaleChooser,showRootChooser:"yes"==i.showRootChooser,availableScaleNames:i.availableScales.split(","),defaultScaleName:i.defaultScale,defaultRootName:i.defaultRoot,scaleCanBeMappedToPiano:!("no"==i.scaleCanBeMappedToPiano),keyboardMappings:i.keyboard?i.keyboard.split(""):[],showKeyboardButton:i.isQuantized&&!isMobile(),lang:i.lang}})).ports.exportScale.subscribe(function(e){m=e,l.stopAll()}),f.ports.keyboardActive.subscribe(function(e){e?KEY_SUPERVISOR.connectWidget(b,S,P):KEY_SUPERVISOR.connectWidget(null,null,null)}),GLOBAL_PITCHPAD_SYNTH||(GLOBAL_PITCHPAD_SYNTH=new PitchpadSynth).init();l=GLOBAL_PITCHPAD_SYNTH;var t=document.getElementById(i.widgetId);(a=document.createElementNS("http://www.w3.org/2000/svg","svg")).classList.add("widget-scale-explorer__mouse-observer"),a.classList.add("grabbable"),a.style.left="0",a.style.bottom="0",a.style.width="100%",t.appendChild(a),r=[];for(var n=0;n<10;n++){var o=document.createElementNS("http://www.w3.org/2000/svg","circle");o.classList.add("widget-scale-explorer__touch"),a.appendChild(o),r.push(o),o.setAttribute("r","15"),o.setAttribute("cx","0"),o.setAttribute("cy","0")}a.appendChild(document.createElement("rect")),a.addEventListener("mousedown",T),a.addEventListener("touchstart",y),a.addEventListener("mousemove",function(e){e.preventDefault()}),a.addEventListener("mouseup",function(e){e.preventDefault()}),L(),window.addEventListener("resize",L),c=C().map(function(e){return!1}),p=C().map(function(e){return!1}),I([]),ANIMATION_FRAMER.requestAnimationFrameCallback(E),i.tip&&function(e){switch(e){case"lowhighpitch":Tooltip.inject(document.getElementById(i.widgetId),function(e){var t=i.tips[e];return t.name=e,t["@close"]=i.lang["@close"],t}(e),"80%")}}(i.tip)}()},this;function g(e){return i.isQuantized?function(e){var t=C(),n=Math.min(Math.max(0,e),s.width-1)/s.width,o=1/t.length;return t[Math.floor(n/o)]}(e):function(e){var t=C(),n=Math.min(Math.max(0,e),s.width)/s.width;return t[0]+n*(t[1]-t[0])}(e)}function h(){return void 0===s&&(s=a.getBoundingClientRect()),s.width}function v(e){void 0===s&&(s=a.getBoundingClientRect());for(var t=[],n=0;n<e.touches.length;n++){var o=e.touches.item(n),i=o.clientX-s.left,r=o.clientY-s.top;t.push([i,r])}return t}function y(e){e.preventDefault(),a.addEventListener("touchmove",function(e){e.preventDefault();for(var t=0;t<e.changedTouches.length;t++){var n=e.changedTouches.item(t),o=n.clientX-s.left;l.moveTouch(n.identifier,g(o),i.isQuantized)}I(v(e))}),a.addEventListener("touchend",function(e){e.preventDefault();for(var t=0;t<e.changedTouches.length;t++){var n=e.changedTouches.item(t),o=n.clientX-s.left;l.stopTouch(n.identifier,g(o))}I(v(e))}),a.addEventListener("touchcancel",function(e){e.preventDefault();for(var t=0;t<e.changedTouches.length;t++){var n=e.changedTouches.item(t),o=n.clientX-s.left;l.stopTouch(n.identifier,g(o))}I(v(e))}),s=a.getBoundingClientRect();for(var t=0;t<e.changedTouches.length;t++){var n=e.changedTouches.item(t),o=n.clientX-s.left;l.startTouch(n.identifier,g(o))}I(v(e))}function E(){if(u){u=!1;for(var e=0;e<r.length;e++){var t=r[e],n=d[e];void 0===n?t.style.opacity="0":(t.style.opacity="1",t.style.transform="translate("+clamp(n[0],0,h())+"px, "+(void 0===s&&(s=a.getBoundingClientRect()),s.height/2)+"px)")}}}function T(e){document.addEventListener("mousemove",o),document.addEventListener("mouseup",function e(t){I([]);l.stopTouch("mouse");document.removeEventListener("mousemove",o);document.removeEventListener("mouseup",e)}),s=a.getBoundingClientRect();var t=e.clientX-s.left,n=e.clientY-s.top;function o(e){var t=e.clientX-s.left;I([[t,e.clientY-s.top]]),l.moveTouch("mouse",g(t),i.isQuantized)}l.startTouch("mouse",g(t)),I([[t,n]]),e.preventDefault()}function w(e){var t=keyEventToPhysicalKey(e);return null==t?-1:i.keyboard.split("").findIndex(function(e){return e.toUpperCase()==t.toUpperCase()})}function b(e){var t=w(e);if(!(t<0)){var n=C()[t];if(l.startTouch("key"+t,n),c[t]=!0,f){var o=R()[t];f.ports.noteOn.send(o)}}}function S(e){var t=w(e);if(!(t<0)&&(l.stopTouch("key"+t),c[t]=!1,f)){var n=R()[t];f.ports.noteOff.send(n)}}function I(e){if(u=!0,d=e,p&&f){var o=C().length,i=[],r=h()/o;d.forEach(function(e){var t=e[0],n=clamp(Math.floor(t/r),0,o-1);i.push(n)});for(var t=0;t<p.length;t++){var n=p[t];if(null!=i.find(function(e){return e==t})){if(!n){p[t]=!0;var a=R()[t];f.ports.noteOn.send(a)}}else if(n){p[t]=!1;a=R()[t];f.ports.noteOff.send(a)}}}}function L(){s=a.getBoundingClientRect(),I([])}function P(){f.ports.resetNoteOnState.send(!0),f.ports.keyboardDisconnected.send(!0);for(var e=0;e<c.length;e++)c[e]&&(l.stopTouch("key"+e),c[e]=!1)}function x(){return i.defaultRoot||i.defaultScale}function C(){return x()?R().map(function(e){return Tone.Frequency(e,"midi").toFrequency()}):i.frequencies.map(function(e){return e.freq})}function R(){return x()?m||[0,2,4,5,7,9,11,12].map(function(e){return e+60}):"no"!=i.scaleCanBeMappedToPiano?i.frequencies.map(function(e){return Math.round(Tone.Frequency(e.freq).toMidi())}):i.frequencies.map(function(e,t){return t})}},SimpleDrumpad=this.SimpleDrumpad=function(){var i,t,e,r,n,o,a,s;return this.init=function(e){if(!BrowserCompatibility.isBrowserCompatible())return void BrowserCompatibility.appendCompatibilityWarning(document.getElementById(e.widgetId),e.lang["@incompatiblebrowser"]);i=e,(t=new Loader).init(i),v()&&t.hide();a=!1,(o=new Drumkit).init(e.kit.samples).then(y)},this;function l(e){return(i.widgetId+e.name).replace(/\s/g,"")}function d(e){!function(e){(e=document.getElementById(l(e))).classList.add("widget__pad--flash"),setTimeout(function(){e.classList.remove("widget__pad--flash")},10)}(e),o.playNoteAtNumber(e.midi,0,e.choke),i.recorder&&i.recorder.recordEvent(e)}function u(){r.innerHTML="";for(var e=0;e<i.kit.samples.length;e++){var t=i.kit.samples[e],n=document.createElement("div");function o(t){return function(e){e.stopPropagation(),e.preventDefault(),d(t)}}n.classList.add("widget__pad"),n.classList.add("widget__pad--drum"),n.id=l(t),n.innerHTML=a?"<kbd class='widget__pad__key'>"+i.keyboard.split("")[e].toUpperCase()+"</kbd><div class='widget__pad__label'>"+t.name+"</div>":"<div class='widget__pad__label'>"+t.name+"</div>",n.addEventListener("mousedown",o(t)),n.addEventListener("touchstart",o(t)),r.appendChild(n)}}function c(e){var t=function(e){var t=keyEventToPhysicalKey(e);return null==t?-1:i.keyboard.split("").findIndex(function(e){return e.toUpperCase()==t.toUpperCase()})}(e);-1!=t&&d(i.kit.samples[t])}function p(e){}function m(){a=!1,g(),u()}function f(){a?(KEY_SUPERVISOR.connectWidget(null,null,null),m()):(KEY_SUPERVISOR.connectWidget(c,p,m),a=!0),g(),u()}function g(){var e=a?"widget__keyboard-button--on":"widget__keyboard-button--off";s.className="btn btn--link btn--cropped widget__keyboard-button "+e}function h(){if(!isMobile()){var e=document.getElementById(i.widgetId);(n=document.createElement("div")).className="widget-drumpad__header",n.style.justifyContent="flex-end",e.appendChild(n),(s=document.createElement("button")).innerHTML=i.lang["@keyboard"],s.onclick=f,Tooltip.appendTooltippableChild(n,s),s.parentElement.style.width="80px",s.parentElement.classList.add("widget__keyboard-button__wrapper"),g()}}function v(){return null!=i.recorder}function y(){t.onAudioLoaded(),SUPERVISOR.makeGestureOnElementResumeAudioContext(document.getElementById(i.widgetId)),e=document.getElementById(i.widgetId),(r=document.createElement("div")).id="padHolder",r.classList.add("widget__pads"),v()?(e.appendChild(r),h()):(h(),e.appendChild(r)),u(),i.tip&&function(e){function t(e){var t=i.tips[e];return t.name=e,t["@close"]=i.lang["@close"],t}switch(e){case"keyboard":if(isMobile())return;Tooltip.inject(s.parentElement,t(e));break;case"drumpad":document.getElementById(i.widgetId).style.position="relative",Tooltip.inject(document.getElementById(i.widgetId),t(e),"95%","25%","left")}}(i.tip)}},PianoRollAssessment={lanesMatch:function(e,t,n){var o=e.events.filter(function(e){return e.lane==n}),i=t.events.filter(function(e){return e.lane==n});return o.length==i.length&&o.every(function(t){return i.find(function(e){return t.start===e.start&&t.duration===e.duration&&t.lane===e.lane})})},populatedLanesMatch:function(e,t,n){if(!e||!t)return!1;for(var o=0;o<n;o++){if(0<e.events.filter(function(e){return e.lane==o}).length&&!PianoRollAssessment.lanesMatch(e,t,o))return!1}return!0},modelsMatch:function(e,t,n){if(!e||!t)return!1;if(e.events.length!=t.events.length)return!1;for(var o=0;o<n;o++)if(!PianoRollAssessment.lanesMatch(e,t,o))return!1;return!0}},PIANOROLL_VERSION=2,PianoRollEditor=this.PianoRollEditor=function(){var o,i,r,a,s,l,d,e,u=this;return u.init=function(e){i=e,function(){for(var e=i.lanes,t=0;t<e.length;t++)void 0===e[t].color&&(e[t].color="none"),void 0===e[t].freq&&(e[t].freq=null),void 0===e[t].midi&&(e[t].midi=null),void 0===e[t].choke&&(e[t].choke=null);(l=document.createElement("div")).style.width=f()+"px",l.style.position="relative",l.style.overflow="hidden",l.style.backgroundColor="#666",Tooltip.appendTooltippableChild(document.getElementById(i.widgetId),l);var n=document.createElement("div");l.appendChild(n),o=Elm.SimplePianoRoll.SimplePianoRoll.init({node:n,flags:{lanes:e,beats:i.beats,gridSize:i.gridSize/4,width:f(),height:m(),labelWidth:E(),scaleName:i.defaultScale?i.defaultScale:null,rootName:i.defaultRoot?i.defaultRoot:null,octave:i.defaultOctave?parseInt(i.defaultOctave):null,octaveCount:i.defaultOctaveCount?parseInt(i.defaultOctaveCount):null,showRootChooser:"yes"==i.showRootChooser,showScaleChooser:"yes"==i.showScaleChooser,availableScales:i.availableScales?i.availableScales.split(","):[],showTempoSlider:"no"!=i.showTempoSlider,showSettings:!0,tempo:parseFloat(i.tempo),highlightedLanes:i.highlightedLanes?i.highlightedLanes:[],options:{allowResize:null==i.allowResize||i.allowResize}}}),o.ports.exportModel.subscribe(function(e){var t=!r||e.page!=r.page,n=!r||e.lanes.length!=r.lanes.length;r=e,u.trigger("modelChange",e),t&&u.trigger("pageChange"),n&&c()}),o.ports.previewNotes.subscribe(function(e){u.trigger("previewNotes",e,!0)}),o.ports.notesSelected.subscribe(function(e){u.trigger("previewNotes",e,!0)}),o.ports.notesDragged.subscribe(function(e){u.trigger("previewNotes",e,!0)}),o.ports.notesAdded.subscribe(function(e){u.trigger("previewNotes",e,!1)}),o.ports.tempoChanged.subscribe(function(e){u.trigger("tempoChanged",e)}),(d=document.createElement("div")).className="widget-pianoroll__mouse-observer-holder",d.style.left=E()+"px",d.style.width=g()+"px",d.style.height=h()+"px",l.appendChild(d),(new SingleTouchObserver).init({node:d,onDown:function(e,t){o.ports.mouseDown.send([e,t])},onMove:function(e,t){o.ports.mouseMove.send([e,t])},onUp:function(e,t){o.ports.mouseUp.send([e,t])}}),(a=document.createElement("div")).className="widget-pianoroll__playhead",a.style.bottom="0px",a.style.height=h()-2+"px",l.appendChild(a),(s=document.createElement("div")).className="widget-pianoroll__playhead",s.style.bottom=p()+"px",s.style.height=y()-1+"px",l.appendChild(s),c(),window.addEventListener("resize",c)}()},u.clear=function(){o.ports.clear.send("")},u.setModel=function(e){if(!e||e.version!=PIANOROLL_VERSION)return;e.lanes=i.lanes,e.showSettings=!0,null!=e.scaleName&&"yes"==i.showScaleChooser||(e.scaleName=i.defaultScale?i.defaultScale:null);null!=e.rootName&&"yes"==i.showRootChooser||(e.rootName=i.defaultRoot?i.defaultRoot:null);e.octave=i.defaultOctave?parseInt(i.defaultOctave):null,e.octaveCount=i.defaultOctaveCount?parseInt(i.defaultOctaveCount):null,null==e.tempo?e.tempo=parseFloat(i.tempo):e.tempo=parseFloat(e.tempo);o.ports.importModel.send(e)},u.getModel=function(e){return r},u.record=function(e){o.ports.record.send([e.lane,e.start])},u.setPlayhead=function(e){if(0<e){s.style.transform="translateX("+(e*g()+E())+"px)",s.style.opacity=1;var t=function(){var e=r?r.page:-1,t=-1==e||0==e?0:4*e-.25,n=-1==e||e==i.beats/4-1?i.beats:4*(e+1)+.25;return[t/i.beats,n/i.beats]}(),n=pctInRange(t[0],t[1],e);fitsInRange(0,1,n)?(a.style.transform="translateX("+(n*g()+E())+"px)",a.style.opacity=1):a.style.opacity=0}else a.style.opacity=0,s.style.opacity=0},u.setOptions=function(e){o.ports.setOptions.send(e)},u.updateTempo=function(e){o.ports.setTempo.send(parseFloat(e))},u.getEditorTooltipWrapper=function(){return l.parentElement},u;function c(){e=parseInt(document.getElementById(i.widgetId).offsetWidth,10),l.style.width=f()+"px",a.style.height=h()-1+"px",d.style.width=g()+"px",d.style.height=h()+"px",s.style.bottom=p()+"px",o.ports.setSize.send([f(),m()])}function p(){return h()+1}function m(){return h()+y()}function f(){return void 0===e&&(e=parseInt(document.getElementById(i.widgetId).offsetWidth,10)),e}function g(){return f()-E()}function h(){return function(){var e=isMobile()?36:60,t=(25-e)/12,n=e-4*t;return clamp(Math.round(t*v()+n),25,e)}()*v()}function v(){return r?r.lanes.length:i.lanes.length}function y(){return 4<i.beats?50:0}function E(){return i?"drums"!=i.material||isMobile()?62:124:62}};MicroEvent.mixin(PianoRollEditor);var PianoRollExport={createExportData:function(t,e,n){var o=t.events.map(function(e){return{midi:PianoRollExport.laneToMidi(t,e.lane),startInBeats:e.start,durationInBeats:e.duration}});return{tempo:e,tracks:[{instrument:n,clip:{lengthInBeats:t.beats,notes:o}}]}},laneToMidi:function(e,t){var n=e.lanes.length,o=e.lanes[n-1-t];return o.freq?Math.round(Tone.Frequency(o.freq).toMidi()):o.midi}},PianoRollPlayer=this.PianoRollPlayer=function(){var n,d,o,i,u=this;return u.setModel=function(e){d=e},u.setLoop=function(e){i=e,n&&(r(),Tone.Transport.position="0:0:0",t())},u.start=t,u.stop=r,u.record=function(e){o=o||[];o.push(e)},u.progress=function(){if(!d||!n)return 0;{if(i){var e=i.start/d.beats,t=i.end/d.beats;return e+n.progress*(t-e)}return n.progress}},u.previewNotes=function(e){var t=function(e){for(var t=[],n=0;n<e.length;n++)val=e[n],t.includes(val)||t.push(val);return t}(e.map(function(e){return e.lane})).map(function(e){var t=d.lanes.length-1-e;return{lane:d.lanes[t],length:"16n",time:"+0.1"}});u.trigger("playNotes",t)},u;function t(e){if(d){void 0===e&&(e=0),function(){var a=1/d.gridSize,s=4*d.gridSize+"n",e=d.gridSize*d.beats,l=d.lanes.length;n&&n.dispose();n=new Tone.Sequence(function(r,e){if(d){var t=e*a;o&&function(t){o=o.filter(function(e){return(e.start+e.duration)%d.beats>t}),0===t&&(o=o.filter(function(e){return e.start+e.duration>d.beats}))}(t);var n=function(t){return d.events.filter(function(e){return e.start==t})}(t).filter(function(t){return!(o&&-1!=o.findIndex(function(e){return e.lane==t.lane}))}).map(function(e){var t=e.duration/a,n=l-e.lane-1,o={};o[s]=t;var i=Tone.Time(o).toNotation();return{lane:d.lanes[n],length:i,time:r}});u.trigger("playNotes",n)}},function(e,t){for(var n=[],o=e;o<t;o++)n.push(o);return n}(0,e),s)}();var t=d.beats*d.gridSize;i?(n.loopStart=Math.floor(i.start/d.beats*t),n.loopEnd=Math.floor(i.end/d.beats*t),n.loop=!0,n.start(e,n.loopStart)):(n.loopStart=0,n.loopEnd=t,n.start(e))}}function r(e){n&&n.stop(e)}};MicroEvent.mixin(PianoRollPlayer);var SimplePianoRoll=this.SimplePianoRoll=function(){var t,i,r,n,o,a,s,l,d,u,c,p=this;return p.init=function(e){if(c=!1,!BrowserCompatibility.isBrowserCompatible())return void BrowserCompatibility.appendCompatibilityWarning(document.getElementById(e.widgetId),e.lang["@incompatiblebrowser"]);isMobile()&&document.getElementById(e.widgetId).classList.add("widget-is-mobile");i=e,(t=new Loader).init(i),i.recorder&&i.recorder.connect(S);i.exporter&&"yes"!=i.disableExport&&i.exporter.registerWidget(p);s=new PianoRollPlayer,"tonal"==i.material?(d=new Piano).init(i.instrument).then(m):"drums"==i.material&&(d=new Drumkit).init(i.instrument.samples).then(m),T(),u=debounce(h,500)},p.showTargetState=function(){r.setTempo(w()),l.setModel(JSON.parse(i.targetState))},p.getExportInfo=function(){return PianoRollExport.createExportData(l.getModel(),r.getTempo(),i.instrument.livePreset)},p.getConfig=function(){return i},p;function m(){t.onAudioLoaded(),SUPERVISOR.makeGestureOnElementResumeAudioContext(document.getElementById(i.widgetId)),function(){var e=document.createElement("div");e.className="widget__menu",document.getElementById(i.widgetId).appendChild(e),(r=new Transport).init({node:e,onStartPlayback:function(){s.start()},onStartQuantizedPlayback:function(){s.start(Workarounds.transportTimeForNextMeasure())},onStopPlayback:function(){s.stop(),d.stopAll()},onPlay:i.onPlay,tempo:w(),onTempoChanged:function(e){l.updateTempo(e),E(),u()},showRecordButton:i.recorder,widgetId:i.widgetId}),(i.defaultState||i.tempo)&&((n=document.createElement("button")).innerHTML=i.lang["@reset"],n.className="widget-button widget-button--hidden",n.onclick=y,e.appendChild(n));(o=document.createElement("button")).innerHTML=i.lang["@clear"],o.className="widget-button",o.style.marginLeft="auto",o.onclick=function(){l.clear()},e.appendChild(o),(a=document.createElement("button")).innerHTML=i.lang["@exporttolive"],a.className="btn btn--link btn--cropped",a.onclick=function(){if(!g())return a.style.pointerEvents="none",a.style.opacity=.25,void f("exportnotsupportedchromeios");a.style.pointerEvents="none",a.innerHTML=i.lang["@exporting"]+"...",p.trigger("export",p,function(e){a.style.pointerEvents="initial",a.innerHTML=i.lang["@exporttolive"],e&&console.log(e)})},"yes"!=i.disableExport&&(Tooltip.appendTooltippableChild(e,a),LiveSetExport.checkExportServiceAvailablility(function(e){a.style.opacity=e?1:.25,a.style.pointerEvents=e?"auto":"none"}))}(),(l=new PianoRollEditor).init(i),l.bind("modelChange",function(e){s.setModel(e),T(),E(),function(){if(o){var e=function(){var e=l?l.getModel():void 0;return!!e&&0<e.events.length}()?"":"widget-button--hidden";o.className="btn btn--link btn--cropped "+e}}(),u()}),l.bind("pageChange",function(){!function(){if("takeover"!=i.onPlay)return;d.stopAll();var e=l?l.getModel():void 0;e&&-1!=e.page?s.setLoop({start:4*e.page,end:4*e.page+4}):s.setLoop({start:0,end:i.beats})}()}),l.bind("previewNotes",function(e,t){!t&&r.isPlaying()||s.previewNotes(e)}),l.bind("tempoChanged",function(e){r.setTempo(e),E(),u()}),s.bind("playNotes",function(e){"tonal"==i.material?e.forEach(function(e){d.playNoteAtFrequency(e.lane.freq,e.time,e.length)}):"drums"==i.material&&d.playNotes(e)}),4===i.beats&&"drums"===i.material&&null==i.recorder&&function(){var e=document.createElement("div");e.className="widget-drumsequencer__column-labels";for(var t=0;t<16;t++){var n=document.createElement("div");n.className="widget-drumsequencer__column-label",t%4==0&&n.classList.add("widget-drumsequencer__column-label--beat"),n.innerHTML=t+1,e.appendChild(n)}document.getElementById(i.widgetId).appendChild(e)}(),i.defaultState&&y();var e=getSavedModel(i.widgetId);e&&(e.tempo&&r.setTempo(e.tempo),l.setModel(e)),i.tip&&f(i.tip),ANIMATION_FRAMER.requestAnimationFrameCallback(v)}function f(e){function t(e){var t=i.tips[e];return t.name=e,t["@close"]=i.lang["@close"],t}switch(e){case"playstop":Tooltip.inject(r.playButton().parentElement,t(e),"100%","50%","left");break;case"record":Tooltip.inject(r.recordButton().parentElement,t(e));break;case"createdeletenotes":Tooltip.inject(l.getEditorTooltipWrapper(),t(e),"70%","60%");break;case"dragnotes":Tooltip.inject(l.getEditorTooltipWrapper(),t(e),"50%","55%");break;case"resizenotes":case"selectnotes":Tooltip.inject(l.getEditorTooltipWrapper(),t(e),"50%","65%");break;case"tempo":Tooltip.inject(l.getEditorTooltipWrapper(),t(e),"15%","50%");break;case"overview":Tooltip.inject(l.getEditorTooltipWrapper(),t(e),"30%","80%","right");break;case"export":g()&&Tooltip.inject(a.parentElement,t(e),"100%","50%","right");break;case"exportnotsupportedchromeios":Tooltip.inject(a.parentElement,t(e),"100%","50%","right")}}function g(){return!isChromeOnIOS()}function h(){if(c){var e=l.getModel();e&&(e.tempo=r.getTempo(),trySaveState(e,i.widgetId,PIANOROLL_VERSION))}else c=!0}function v(){var e=r.isPlaying()?s.progress():0;l.setPlayhead(e)}function y(){if(r.setTempo(w()),i.defaultState)l.setModel(JSON.parse(i.defaultState));else if(i.defaultRoot||i.defaultScale){var e=l.getModel();e.scaleName=i.defaultScale,e.rootName=i.defaultRoot,e.tempo=w(),l.setModel(e)}}function E(){if(n){var e=function(){var e=l?l.getModel():void 0;return i.defaultState?w()===r.getTempo()&&b(e)&&PianoRollAssessment.modelsMatch(JSON.parse(i.defaultState),l.getModel(),i.lanes.length):w()===r.getTempo()&&b(e)}()?"widget-button--hidden":"";n.className="btn btn--link btn--cropped "+e}}function T(){var e=document.getElementById(i.widgetId+"correct"),t=document.getElementById(i.widgetId+"generic");if(e&&t){var n=function(){var e=l?l.getModel():void 0;if(!i.targetState||!e)return!1;{if("tonal"==i.material)return PianoRollAssessment.modelsMatch(JSON.parse(i.targetState),l.getModel(),e.lanes.length);if("drums"==i.material)return PianoRollAssessment.populatedLanesMatch(JSON.parse(i.targetState),l.getModel(),e.lanes.length)}}();e.className=n?"widget__dynamic-text":"widget__dynamic-text widget__dynamic-text--hidden",t.className=n?"widget__dynamic-text widget__dynamic-text--hidden":"widget__dynamic-text"}}function w(){return i.tempo?parseInt(i.tempo):85}function b(e){if(!e)return!0;var t=!i.defaultRoot||i.defaultRoot===e.rootName,n=!i.defaultScale||i.defaultScale===e.scaleName;return t&&n}function S(e){var t=i.lanes.map(function(e){return e.midi}),n=i.lanes.length-t.indexOf(e.midi)-1,o=s.progress()*i.beats;r.isRecording()&&r.isPlaying()&&(l.record({lane:n,start:o,duration:.25}),s.record({lane:n,start:o,duration:.25}))}};MicroEvent.mixin(SimplePianoRoll);var SimpleSession=this.SimpleSession=function(){var o,n,i,r,a,s,l,d;return this.init=function(e){if(!BrowserCompatibility.isBrowserCompatible())return void BrowserCompatibility.appendCompatibilityWarning(document.getElementById(e.widgetId),e.lang["@incompatiblebrowser"]);o=e,r=document.getElementById(o.widgetId),(i=new Loader).init(o),l=0,d=[],o.preset.tracks.forEach(function(e,t){var n=[];e.clips.forEach(function(e){n.push({name:e.name,measureStarted:0,duration:parseInt(e.length),state:"stopped"})}),d.push(n)}),Tone.Transport.bpm.value=o.preset.tempo;var t=function(e){var o={},i=getAudioExtension();return e.tracks.forEach(function(e,t){e.clips.forEach(function(e,t){var n=e.name;o[n]=pathToWidgetSounds()+e.path+i})}),o}(o.preset);s=new Tone.Players({urls:t,onload:function(){!function(){i.onAudioLoaded(),SUPERVISOR.makeGestureOnElementResumeAudioContext(r),a=document.createElement("div"),Tooltip.appendTooltippableChild(r,a);for(var e=0;e<o.preset.tracks.length;e++){var t=o.preset.tracks[e];t.name=t["@name"]}n=Elm.SimpleSession.SimpleSession.init({node:a,flags:o.preset}),Tone.Transport.scheduleRepeat(function(t){d.forEach(function(e){e.forEach(function(e){"shouldStop"===e.state&&(s.player(e.name).stop(t),e.state="stopped"),"shouldStart"===e.state&&(s.player(e.name).start(t,0),e.state="playing",e.measureStarted=l),"playing"===e.state&&l-e.measureStarted===e.duration&&(s.player(e.name).restart(t,0),e.measureStarted=l)})}),n.ports.onTick.send(""+t),l++},"1m"),n.ports.playSound.subscribe(function(e){"stopped"==Tone.Transport.state&&(Tone.Transport.position="0:0:0",Tone.Transport.start(ToneTransportStartDelay()),SUPERVISOR.registerPlayingWidget(o.widgetId));var t=e[0],n=e[1];d[n].forEach(function(e){e.state="shouldStop"}),d[n].forEach(function(e){e.name===t.name&&(e.state="shouldStart")})}),n.ports.unqueueSound.subscribe(function(t){d.forEach(function(e){e.forEach(function(e){e.name===t.name&&(e.state="stopped")})})}),n.ports.stopSound.subscribe(function(t){d.forEach(function(e){e.forEach(function(e){e.name===t.name&&(e.state="shouldStop")})})}),n.ports.allSoundsStopped.subscribe(function(e){SUPERVISOR.isOnlyWidgetPlaying(o.widgetId)&&(Tone.Transport.position="0:0:0",Tone.Transport.stop()),d.forEach(function(e){e.forEach(function(e){e.state="shouldStop"})}),SUPERVISOR.unregisterPlayingWidget(o.widgetId)}),o.tip&&function(e){switch(e){case"devicemute":if(!isMobile())return;Tooltip.inject(a,function(e){var t=o.tips[e];return t.name=e,t["@close"]=o.lang["@close"],t}(e),"65%","60%","right")}}(o.tip)}()}}).toDestination()},this},SongFormExplorer=this.SongFormExplorer=function(){var i,r,a;return this.init=function(e){a=e,r=document.getElementById(a.widgetId),function(){var e=document.createElement("div");r.appendChild(e);for(var t=0;t<a.preset.sections.length-1;t++){var n=a.preset.sections[t],o=a.preset.sections[t+1];n.end=o.start}a.preset.sections[a.preset.sections.length-1].end=a.preset.songLength;for(t=0;t<a.preset.sections.length;t++){(n=a.preset.sections[t]).description=n["@description"],n.name=n["@name"],n.label=n["@label"]}for(t=0;t<a.preset.sections.length;t++){(n=a.preset.sections[t])["@label"]||(n.label=n.name)}i=Elm.SongFormExplorer.SongFormExplorer.init({node:e,flags:a.preset}),i.ports.jumpToSection.subscribe(function(e){a.player.setPlayheadToTime(e.start)}),ANIMATION_FRAMER.requestAnimationFrameCallback(l),a.player.setPlayheadChangedCallback(s),a.tip&&function(e){switch(e){case"songformsections":r.style.position="relative",Tooltip.inject(r,function(e){var t=a.tips[e];return t.name=e,t["@close"]=a.lang["@close"],t}(e),"45px","65%")}}(a.tip)}()},this;function s(e){i.ports.updatePlayhead.send(e)}function l(){var e=document.getElementsByClassName("widget-songform__section-description__text")[0];if(e){var t=e.dataset.description;e.innerHTML=t}}};function onYouTubeIframeAPIReady(){YOUTUBEWIDGETS.forEach(function(e){e.onYouTubeIframeAPIReady()}),YOUTUBE_API_READY=!0}YOUTUBEWIDGETS=[],YOUTUBE_API_READY=!1;var YouTube=this.YouTube=function(){var n,t,o,i,r,a,s=this;return s.init=function(e){n=e,t=document.getElementById(n.widgetId),(o=document.createElement("div")).className="widget-video__holder",o.id=n.widgetId+"video",o.style.display="none",t.appendChild(o),n.width&&(o.style.width=n.width+"px");a=!1,YOUTUBE_API_READY?this.onYouTubeIframeAPIReady():YOUTUBEWIDGETS.push(s)},s.onYouTubeIframeAPIReady=function(){document.getElementById(n.widgetId).classList.add("is-youtube-api-ready"),t.addEventListener("click",c)},s.setPlayheadChangedCallback=function(e){r=e},s.setPlayheadToTime=function(e){if(void 0===i||void 0===i.getPlayerState)return;i.getPlayerState()!=YT.PlayerState.PLAYING&&r&&r(e);i.seekTo(e),a&&i.playVideo();Tone.Transport.emit("takeover",n.widgetId)},s;function e(e){document.getElementById(n.widgetId+"video").style.display="block",Tone.Transport.on("takeover",l),document.getElementById(n.widgetId).classList.add("is-video-ready"),ANIMATION_FRAMER.requestAnimationFrameCallback(d)}function l(e){"takeover"==n.onPlay&&e!=n.widgetId&&i.getPlayerState()===YT.PlayerState.PLAYING&&(i.pauseVideo(),a=!0)}function d(){i&&i.getPlayerState()==YT.PlayerState.PLAYING&&r&&r(i.getCurrentTime())}function u(e){if(e.data==YT.PlayerState.PLAYING||e.data==YT.PlayerState.BUFFERING){var t=document.getElementById(n.widgetId);t.classList.remove("is-ready"),t.classList.add("is-playing")}e.data==YT.PlayerState.PLAYING?("takeover"==n.onPlay&&Tone.Transport.emit("takeover",n.widgetId),SUPERVISOR.registerPlayingWidget(n.widgetId),a=!1):SUPERVISOR.unregisterPlayingWidget(n.widgetId)}function c(){i=new YT.Player(n.widgetId+"video",{videoId:n.videoId,playerVars:{controls:2,disablekb:1,showinfo:0,color:"white",modestbranding:1,fs:0,playsinline:1,start:n.start?parseInt(n.start):0,end:n.end?parseInt(n.end):void 0,loop:n.loop&&"yes"===n.loop?1:0,host:"https://www.youtube-nocookie.com"},events:{onReady:e,onStateChange:u}})}};